{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
set -e


echo "=== Installing APT packages ==="
sudo apt update -y
{{ range .packages.linux.apt_packages -}}
sudo apt install -y {{ . | quote }}
{{ end }}

# --- Locale Fix --- 
DESIRED_LOCALE="${LC_ALL:-${LANG:-C.UTF-8}}"
echo "Using locale: $DESIRED_LOCALE"
sudo apt install -y locales
if ! locale -a | grep -qi "^${DESIRED_LOCALE}$"; then
  echo "Generating locale: $DESIRED_LOCALE" 
  sudo sed -i "s/# ${DESIRED_LOCALE} UTF-8/${DESIRED_LOCALE} UTF-8/" /etc/locale.gen || true 
  echo "${DESIRED_LOCALE} UTF-8" | sudo tee -a /etc/locale.gen >/dev/null 
  sudo locale-gen 
fi

sudo update-locale LANG="$DESIRED_LOCALE" LC_ALL="$DESIRED_LOCALE"

echo "=== Installing Node.js via n ==="

# Install n (Node binary manager)
curl -L https://raw.githubusercontent.com/tj/n/master/bin/n -o n
sudo bash n {{ .packages.linux.node_install.version }}
rm n

# Verify installation
echo "Node version: $(node -v)"
echo "npm version: $(npm -v)"

echo "=== Installing npm packages ==="
{{ range .packages.linux.node_install.packages -}}
sudo npm install -g {{ . | quote }}
{{ end }}

echo "=== Installing .deb packages ==="
{{ range .packages.linux.deb_install_packages -}}
curl -L -o {{ .file | quote }} {{ .url | quote }}
sudo apt install -y ./{{ .file | quote }}
rm -f {{ .file | quote }}
{{ end }}

echo "=== Installing AppImage packages ==="
{{ range .packages.linux.appimage_install_packages }}
curl -L -o {{ .file | quote }} {{ .url | quote }}
chmod +x {{ .file | quote }}
sudo mv {{ .file | quote }} {{ .target | quote }}
{{ end }}

echo "=== Installing tarball packages ==="
{{ range .packages.linux.tar_install_packages }}
echo "Installing from tarball: {{ .url }}"

# Download
curl -L -o {{ .file | quote }} {{ .url | quote }}

# Prepare target directory
sudo rm -rf {{ .target | quote }}
sudo mkdir -p {{ .target | quote }}

# Extract
sudo tar xzf {{ .file | quote }} -C {{ .target | quote }}{{ if .extract_dir }} --strip-components=1{{ end }}

# Optional symlink
{{ if .symlink }}
sudo ln -sf {{ .target | quote }}/bin/$(basename {{ .symlink | quote }}) {{ .symlink | quote }}
{{ end }}

# Cleanup
rm -f {{ .file | quote }}

{{ end }}

{{ end -}}

